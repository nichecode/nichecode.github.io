<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#FFFFFF"><title>Architecting for Testability in Go (Part 2): Implementation Strategy and Code Examples &#183; Nicholas Hammond</title>
<meta name=title content="Architecting for Testability in Go (Part 2): Implementation Strategy and Code Examples &#183; Nicholas Hammond"><script type=text/javascript src=/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.8f25b3b1fdd42cfaf2092d7e98b41f6474cfaf471f6aeb265f7ba2579197e54e.css integrity="sha256-jyWzsf3ULPryCS1+mLQfZHTPr0cfausmX3uiV5GX5U4="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.90a48a144b2de1542549eda42e3a5a686046f98731a313b07209f4432d7f0946.js integrity="sha256-kKSKFEst4VQlSe2kLjpaaGBG+YcxoxOwcgn0Qy1/CUY=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      Practical implementation details and code examples for testable Go applications
    "><meta name=robots content="index, follow"><link rel=canonical href=https://nichecode.github.io/posts/architecting-for-testability-in-go/part-2/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://nichecode.github.io/posts/architecting-for-testability-in-go/part-2/"><meta property="og:site_name" content="Nicholas Hammond"><meta property="og:title" content="Architecting for Testability in Go (Part 2): Implementation Strategy and Code Examples"><meta property="og:description" content="Practical implementation details and code examples for testable Go applications"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-10T02:00:00+00:00"><meta property="article:modified_time" content="2025-04-10T02:00:00+00:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Testing"><meta property="article:tag" content="Architecture"><meta property="article:tag" content="Clean-Code"><meta name=twitter:card content="summary"><meta name=twitter:title content="Architecting for Testability in Go (Part 2): Implementation Strategy and Code Examples"><meta name=twitter:description content="Practical implementation details and code examples for testable Go applications"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Architecting for Testability in Go (Part 2): Implementation Strategy and Code Examples","headline":"Architecting for Testability in Go (Part 2): Implementation Strategy and Code Examples","description":"Practical implementation details and code examples for testable Go applications","abstract":"\u003cdiv class=\u0022flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900\u0022\u003e\n  \u003cspan class=\u0022pe-3 text-primary-400\u0022\u003e\n    \u003cspan class=\u0022icon relative inline-block px-1 align-text-bottom\u0022\u003e\u003csvg xmlns=\u0022http:\/\/www.w3.org\/2000\/svg\u0022 viewBox=\u00220 0 512 512\u0022\u003e\u003cpath fill=\u0022currentColor\u0022 d=\u0022M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z\u0022\/\u003e\u003c\/svg\u003e\n\u003c\/span\u003e\n  \u003c\/span\u003e\n  \u003cspan class=\u0022dark:text-neutral-300\u0022\u003eThis is Part 2 of a 3-part series on architecting Go applications for testability. This part provides concrete implementation details and code examples.\u003c\/span\u003e\n\u003c\/div\u003e\n\n\u003ch2 id=\u0022tldr\u0022 class=\u0022relative group\u0022\u003eTL;DR \u003cspan class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100\u0022\u003e\u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022 style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#tldr\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\u003c\/span\u003e\u003c\/h2\u003e\u003cp\u003eThis part provides practical implementation details and code examples for our testable architecture approach. We\u0026rsquo;ll cover interface definition, real implementations, fake implementations, and testing patterns, with complete code examples you can adapt for your projects.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/nichecode.github.io\/posts\/architecting-for-testability-in-go\/part-2\/","author":{"@type":"Person","name":"Nicholas Hammond"},"copyrightYear":"2025","dateCreated":"2025-04-10T02:00:00\u002b00:00","datePublished":"2025-04-10T02:00:00\u002b00:00","dateModified":"2025-04-10T02:00:00\u002b00:00","keywords":["go","testing","architecture","clean-code"],"mainEntityOfPage":"true","wordCount":"2337"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://nichecode.github.io/","name":"Nicholas Hammond","position":1},{"@type":"ListItem","item":"https://nichecode.github.io/posts/","name":"Posts","position":2},{"@type":"ListItem","item":"https://nichecode.github.io/posts/architecting-for-testability-in-go/","name":"Architecting for Testability in Go Using Fakes, Not Mocks","position":3},{"@type":"ListItem","item":"https://nichecode.github.io/categories/software-development/","name":"Software Development","position":4},{"@type":"ListItem","name":"Architecting for Testability in Go ( Part 2) Implementation Strategy and Code Examples","position":5}]}</script><meta name=author content="Nicholas Hammond"><link href=https://github.com/nichecode rel=me></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden"><nav class="flex items-start justify-between sm:items-center"><div class="z-40 flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Nicholas Hammond</a></div><label id=menu-button for=menu-controller class="block sm:hidden"><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"><ul class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"><li class=mb-1><span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class="group mb-1"><a href=/posts/ title=Posts onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1"><a href=/tags/ title=Tags onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="group mb-1"><a href=/categories/ title=Categories onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Categories</span></a></li><li class="group mb-1"><a href=/about/ title=About onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">About</span></a></li><li class="group mb-1"><button id=search-button-1 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li></ul></div></label><ul class="hidden list-none flex-row text-end sm:flex"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/tags/ title=Tags><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/categories/ title=Categories><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Categories</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/about/ title=About><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">About</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=search-button-2 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="hidden inline"><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/>Nicholas Hammond</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/posts/architecting-for-testability-in-go/>Architecting for Testability in Go: Using Fakes, Not Mocks</a><span class="px-1 text-primary-500">/</span></li><li class="hidden inline"><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/posts/architecting-for-testability-in-go/part-2/>Architecting for Testability in Go (Part 2): Implementation Strategy and Code Examples</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Architecting for Testability in Go (Part 2): Implementation Strategy and Code Examples</h1><div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2025-04-10 02:00:00 +0000 UTC">10 April 2025</time><span class="px-2 text-primary-500">&#183;</span><span>2337 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">11 mins</span></div><div class="my-1 flex flex-wrap text-xs leading-relaxed text-neutral-500 dark:text-neutral-400"><a href=/categories/software-development/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Software Development</a>
<a href=/tags/go/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Go</a>
<a href=/tags/testing/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Testing</a>
<a href=/tags/architecture/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Architecture</a>
<a href=/tags/clean-code/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Clean-Code</a></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 lg:sticky lg:top-10 print:hidden"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#from-theory-to-practice>From Theory to Practice</a></li><li><a href=#implementation-strategy-for-fake-based-testing>Implementation Strategy for Fake-Based Testing</a><ul><li><a href=#1-define-clear-interfaces-in-the-application-layer>1. Define Clear Interfaces in the Application Layer</a></li></ul></li><li><a href=#decoupling-from-external-contracts>Decoupling from External Contracts</a><ul><li><a href=#2-create-real-implementations-in-the-infrastructure-layer>2. Create Real Implementations in the Infrastructure Layer</a></li><li><a href=#3-create-comprehensive-fake-implementations>3. Create Comprehensive Fake Implementations</a></li><li><a href=#4-where-should-fake-implementations-live>4. Where Should Fake Implementations Live?</a></li><li><a href=#5-writing-tests-with-fakes>5. Writing Tests with Fakes</a></li></ul></li><li><a href=#testing-logging-with-fakes>Testing Logging with Fakes</a></li><li><a href=#factory-pattern-for-implementation-selection>Factory Pattern for Implementation Selection</a></li><li><a href=#test-classification-strategy>Test Classification Strategy</a></li><li><a href=#directory-structure-for-tests>Directory Structure for Tests</a></li><li><a href=#coming-up-in-part-3>Coming Up in Part 3</a></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>This is Part 2 of a 3-part series on architecting Go applications for testability. This part provides concrete implementation details and code examples.</span></div><h2 id=tldr class="relative group">TL;DR <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#tldr aria-label=Anchor>#</a></span></h2><p>This part provides practical implementation details and code examples for our testable architecture approach. We&rsquo;ll cover interface definition, real implementations, fake implementations, and testing patterns, with complete code examples you can adapt for your projects.</p><h2 id=from-theory-to-practice class="relative group">From Theory to Practice <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#from-theory-to-practice aria-label=Anchor>#</a></span></h2><p>In
<a href=/posts/architecting-for-testability-in-go/part-1/>Part 1</a>, we established the theoretical foundations of our approach. Now it&rsquo;s time to see how these principles translate into actual Go code.</p><p>Our implementation strategy follows these key steps:</p><ol><li>Define clear interfaces in the application layer</li><li>Create real implementations in the infrastructure layer</li><li>Create comprehensive fake implementations for testing</li><li>Write tests using these fakes</li><li>Use a factory pattern to select the appropriate implementation</li></ol><p>Let&rsquo;s walk through each step with concrete code examples.</p><h2 id=implementation-strategy-for-fake-based-testing class="relative group">Implementation Strategy for Fake-Based Testing <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implementation-strategy-for-fake-based-testing aria-label=Anchor>#</a></span></h2><p>In
<a href=/posts/architecting-for-testability-in-go/part-1/>Part 1</a>, we laid out the architectural foundations for testable Go applications. Now, let&rsquo;s dive into concrete implementation details with comprehensive code examples.</p><h3 id=1-define-clear-interfaces-in-the-application-layer class="relative group">1. Define Clear Interfaces in the Application Layer <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-define-clear-interfaces-in-the-application-layer aria-label=Anchor>#</a></span></h3><p>The foundation of our approach is defining interfaces in the application layer that express what the application needs, not how those needs are implemented:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>application</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/domain&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Repository defines storage operations needed by the service.</span>
</span></span><span class=line><span class=cl><span class=c1>// Why interfaces? To decouple application logic from specific storage tech.</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Repository</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>id</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>entity</span> <span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Logger defines logging capabilities needed.</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Logger</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Info</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>msg</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>args</span> <span class=o>...</span><span class=kt>any</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>Error</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>msg</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>args</span> <span class=o>...</span><span class=kt>any</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>With</span><span class=p>(</span><span class=nx>args</span> <span class=o>...</span><span class=kt>any</span><span class=p>)</span> <span class=nx>Logger</span> <span class=c1>// For creating contextual loggers</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The key insight: the application defines what it needs, not how those needs are met. This inversion of dependencies is crucial for testability.</p><p>While the application layer contains imperative code that orchestrates workflows, all complex business rules and logic should be delegated to the pure functional domain layer. This keeps the application layer focused on coordination rather than complex logic.</p><p>It&rsquo;s important to note that the infrastructure layer serves two vital roles in this architecture:</p><ol><li>It implements the interfaces defined by the application layer (like Repository, Logger)</li><li>It provides the entry points that invoke the application layer&rsquo;s services (HTTP handlers, message consumers, CLI commands)</li></ol><p>This dual role makes the infrastructure layer the bridge between the outside world and your core application logic.</p><h2 id=decoupling-from-external-contracts class="relative group">Decoupling from External Contracts <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#decoupling-from-external-contracts aria-label=Anchor>#</a></span></h2><p>A critical aspect of this architecture is protecting the domain from external contract dependencies:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// application/contracts/api/request.go</span>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>api</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// UserActivationRequest is an API contract, owned by the application layer</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UserActivationRequest</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>UserID</span> <span class=kt>string</span> <span class=s>`json:&#34;user_id&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Reason</span> <span class=kt>string</span> <span class=s>`json:&#34;reason,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// application/service.go</span>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>application</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/application/contracts/api&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/domain&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>UserService</span><span class=p>)</span> <span class=nf>ActivateUser</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>api</span><span class=p>.</span><span class=nx>UserActivationRequest</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Map from API contract to domain model</span>
</span></span><span class=line><span class=cl>    <span class=nx>userID</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>UserID</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Get domain entity from storage</span>
</span></span><span class=line><span class=cl>    <span class=nx>entity</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>repo</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Use domain logic to perform activation (pure function)</span>
</span></span><span class=line><span class=cl>    <span class=nx>activatedEntity</span> <span class=o>:=</span> <span class=nx>domain</span><span class=p>.</span><span class=nf>ActivateUser</span><span class=p>(</span><span class=nx>entity</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Reason</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Save updated entity</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>repo</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>activatedEntity</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// infrastructure/http/handler.go</span>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>http</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/application&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/application/contracts/api&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>UserHandler</span><span class=p>)</span> <span class=nf>ActivateUser</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Parse request into API contract</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>req</span> <span class=nx>api</span><span class=p>.</span><span class=nx>UserActivationRequest</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>req</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Call application service with API contract</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nf>ActivateUser</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Handle error</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Send response</span>
</span></span><span class=line><span class=cl>    <span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This separation is critical because:</p><ol><li><strong>Domain Purity</strong>: Domain models remain uncontaminated by API/messaging concerns (like JSON tags, validation rules)</li><li><strong>Contract Ownership</strong>: The application layer completely owns all external contracts</li><li><strong>Mapping Control</strong>: The application layer handles all translation between external contracts and domain models</li><li><strong>Package Structure Enforcement</strong>: The structure makes it impossible for external concerns to leak into the domain due to import paths</li><li><strong>Compatibility Management</strong>: API or message format changes can be handled in the application layer without affecting domain logic</li><li><strong>Domain Model Protection</strong>: Domain models are only exposed to the application layer and persistence - they never cross external boundaries or service boundaries directly</li></ol><p>Whether contracts live in <code>internal/application/contracts/...</code> or a shared <code>pkg/</code> directory, the key principle remains: domain models never leak outside and external contracts never leak in.</p><h3 id=2-create-real-implementations-in-the-infrastructure-layer class="relative group">2. Create Real Implementations in the Infrastructure Layer <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-create-real-implementations-in-the-infrastructure-layer aria-label=Anchor>#</a></span></h3><p>Now let&rsquo;s implement these interfaces with concrete types:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>storage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/application&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/domain&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// PostgresRepository implements application.Repository using Postgres.</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>PostgresRepository</span> <span class=kd>struct</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewPostgresRepository</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>PostgresRepository</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>PostgresRepository</span><span class=p>{</span><span class=nx>db</span><span class=p>:</span> <span class=nx>db</span><span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>PostgresRepository</span><span class=p>)</span> <span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>id</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// Implementation using SQL queries with the DB connection</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>{},</span> <span class=kc>nil</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>PostgresRepository</span><span class=p>)</span> <span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>entity</span> <span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// Implementation using SQL queries</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Compile-time verification that PostgresRepository implements Repository</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>application</span><span class=p>.</span><span class=nx>Repository</span> <span class=p>=</span> <span class=p>(</span><span class=o>*</span><span class=nx>PostgresRepository</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)</span>
</span></span></code></pre></div><p>Similar implementations would exist for other interfaces like <code>Logger</code> with a real logging implementation.</p><h3 id=3-create-comprehensive-fake-implementations class="relative group">3. Create Comprehensive Fake Implementations <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-create-comprehensive-fake-implementations aria-label=Anchor>#</a></span></h3><p>Here&rsquo;s where the magic happens - creating fake implementations that are robust enough for thorough testing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>storage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/application&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/domain&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/ctxkeys&#34;</span> <span class=c1>// For context key handling</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// FakeRepository implements application.Repository for testing and dry-run.</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>FakeRepository</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mu</span>         <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>entities</span>   <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span>
</span></span><span class=line><span class=cl>    <span class=nx>operations</span> <span class=p>[]</span><span class=nx>OperationLog</span> <span class=c1>// Records all operations for verification</span>
</span></span><span class=line><span class=cl>    <span class=nx>saveErr</span>    <span class=kt>error</span>          <span class=c1>// For simulating errors</span>
</span></span><span class=line><span class=cl>    <span class=nx>getErr</span>     <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// OperationLog records details about calls made to the fake.</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>OperationLog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>OperationType</span> <span class=kt>string</span>         <span class=c1>// &#34;Get&#34;, &#34;Save&#34;, etc.</span>
</span></span><span class=line><span class=cl>    <span class=nx>Params</span>        <span class=nx>OperationParams</span>
</span></span><span class=line><span class=cl>    <span class=nx>Timestamp</span>     <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>    <span class=nx>CorrelationID</span> <span class=kt>string</span> <span class=c1>// Example of capturing context data</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// OperationParams uses a union-like approach for type safety.</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>OperationParams</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>GetParams</span>  <span class=o>*</span><span class=nx>GetParams</span>  <span class=c1>// Only one of these will be non-nil</span>
</span></span><span class=line><span class=cl>    <span class=nx>SaveParams</span> <span class=o>*</span><span class=nx>SaveParams</span> <span class=c1>// depending on operation type</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>GetParams</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ID</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SaveParams</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Entity</span> <span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewFakeRepository</span><span class=p>()</span> <span class=o>*</span><span class=nx>FakeRepository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>FakeRepository</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>entities</span><span class=p>:</span>   <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>operations</span><span class=p>:</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>OperationLog</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get implements the Repository interface</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeRepository</span><span class=p>)</span> <span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>id</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Extract correlation ID from context as an example</span>
</span></span><span class=line><span class=cl>    <span class=nx>corrID</span> <span class=o>:=</span> <span class=nx>ctxkeys</span><span class=p>.</span><span class=nf>GetCorrelationID</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Record this operation</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>operations</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>operations</span><span class=p>,</span> <span class=nx>OperationLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>OperationType</span><span class=p>:</span> <span class=s>&#34;Get&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Params</span><span class=p>:</span> <span class=nx>OperationParams</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>GetParams</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>GetParams</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=nx>id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>Timestamp</span><span class=p>:</span>     <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>CorrelationID</span><span class=p>:</span> <span class=nx>corrID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Simulate error if configured</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>getErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>{},</span> <span class=nx>f</span><span class=p>.</span><span class=nx>getErr</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Otherwise return the entity from the in-memory map</span>
</span></span><span class=line><span class=cl>    <span class=nx>entity</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>entities</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;entity %s not found&#34;</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>entity</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Save implements the Repository interface </span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeRepository</span><span class=p>)</span> <span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>entity</span> <span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>corrID</span> <span class=o>:=</span> <span class=nx>ctxkeys</span><span class=p>.</span><span class=nf>GetCorrelationID</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>operations</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>operations</span><span class=p>,</span> <span class=nx>OperationLog</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>OperationType</span><span class=p>:</span> <span class=s>&#34;Save&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Params</span><span class=p>:</span> <span class=nx>OperationParams</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>SaveParams</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>SaveParams</span><span class=p>{</span><span class=nx>Entity</span><span class=p>:</span> <span class=nx>entity</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>Timestamp</span><span class=p>:</span>     <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>CorrelationID</span><span class=p>:</span> <span class=nx>corrID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>saveErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=nx>saveErr</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>entities</span><span class=p>[</span><span class=nx>entity</span><span class=p>.</span><span class=nx>ID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>entity</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Test Helper Methods (for convenient test setup and verification)</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeRepository</span><span class=p>)</span> <span class=nf>WithEntities</span><span class=p>(</span><span class=nx>entities</span> <span class=o>...</span><span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>)</span> <span class=o>*</span><span class=nx>FakeRepository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>entities</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>f</span><span class=p>.</span><span class=nx>entities</span><span class=p>[</span><span class=nx>e</span><span class=p>.</span><span class=nx>ID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>f</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeRepository</span><span class=p>)</span> <span class=nf>SimulateGetError</span><span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=o>*</span><span class=nx>FakeRepository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>getErr</span> <span class=p>=</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>f</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeRepository</span><span class=p>)</span> <span class=nf>SimulateSaveError</span><span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=o>*</span><span class=nx>FakeRepository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>saveErr</span> <span class=p>=</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>f</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeRepository</span><span class=p>)</span> <span class=nf>GetOperations</span><span class=p>()</span> <span class=p>[]</span><span class=nx>OperationLog</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Return a copy to prevent modification issues</span>
</span></span><span class=line><span class=cl>    <span class=nx>opsCopy</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>OperationLog</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>operations</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>copy</span><span class=p>(</span><span class=nx>opsCopy</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>operations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>opsCopy</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Ensure the fake implements the interface</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>application</span><span class=p>.</span><span class=nx>Repository</span> <span class=p>=</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeRepository</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)</span>
</span></span></code></pre></div><p>This <code>FakeRepository</code> is comprehensive:</p><ul><li>It maintains state in memory (the <code>entities</code> map)</li><li>It records all operations for verification</li><li>It can be configured to simulate errors</li><li>It includes helper methods for test setup</li><li>It handles thread safety with mutex locks</li></ul><p>Similarly, we can implement a fake logger:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>logging_test</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/application&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// LogEntry captures details of a log call.</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>LogEntry</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Level</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Message</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Args</span>    <span class=p>[]</span><span class=kt>any</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// FakeLogger implements application.Logger for testing.</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>FakeLogger</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mu</span>      <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>entries</span> <span class=p>[]</span><span class=nx>LogEntry</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewFakeLogger</span><span class=p>()</span> <span class=o>*</span><span class=nx>FakeLogger</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>FakeLogger</span><span class=p>{</span><span class=nx>entries</span><span class=p>:</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>LogEntry</span><span class=p>,</span> <span class=mi>0</span><span class=p>)}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeLogger</span><span class=p>)</span> <span class=nf>Info</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>msg</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>args</span> <span class=o>...</span><span class=kt>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nf>log</span><span class=p>(</span><span class=s>&#34;info&#34;</span><span class=p>,</span> <span class=nx>msg</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeLogger</span><span class=p>)</span> <span class=nf>Error</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>msg</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>args</span> <span class=o>...</span><span class=kt>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nf>log</span><span class=p>(</span><span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>msg</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeLogger</span><span class=p>)</span> <span class=nf>With</span><span class=p>(</span><span class=nx>args</span> <span class=o>...</span><span class=kt>any</span><span class=p>)</span> <span class=nx>application</span><span class=p>.</span><span class=nx>Logger</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// For simplicity, this example just returns self</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A more sophisticated fake might track these args</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>f</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeLogger</span><span class=p>)</span> <span class=nf>log</span><span class=p>(</span><span class=nx>level</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>msg</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Copy args to prevent modification issues</span>
</span></span><span class=line><span class=cl>    <span class=nx>argsCopy</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>any</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>copy</span><span class=p>(</span><span class=nx>argsCopy</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>entries</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>entries</span><span class=p>,</span> <span class=nx>LogEntry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Level</span><span class=p>:</span>   <span class=nx>level</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Message</span><span class=p>:</span> <span class=nx>msg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Args</span><span class=p>:</span>    <span class=nx>argsCopy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Helper methods for tests</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeLogger</span><span class=p>)</span> <span class=nf>Count</span><span class=p>()</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>entries</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeLogger</span><span class=p>)</span> <span class=nf>GetEntries</span><span class=p>()</span> <span class=p>[]</span><span class=nx>LogEntry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Return a copy</span>
</span></span><span class=line><span class=cl>    <span class=nx>entriesCopy</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>LogEntry</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>entries</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>copy</span><span class=p>(</span><span class=nx>entriesCopy</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>entries</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>entriesCopy</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>FakeLogger</span><span class=p>)</span> <span class=nf>ContainsMessage</span><span class=p>(</span><span class=nx>substr</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>entry</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>f</span><span class=p>.</span><span class=nx>entries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span> <span class=nx>substr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>application</span><span class=p>.</span><span class=nx>Logger</span> <span class=p>=</span> <span class=p>(</span><span class=o>*</span><span class=nx>FakeLogger</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=4-where-should-fake-implementations-live class="relative group">4. Where Should Fake Implementations Live? <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-where-should-fake-implementations-live aria-label=Anchor>#</a></span></h3><p>The placement of fake implementations depends on their purpose:</p><ul><li><strong>For testing only</strong>: Place in <code>*_test.go</code> files within the package of the real implementation</li><li><strong>For testing AND features</strong> (like dry-run mode): Place in regular <code>.go</code> files</li></ul><p>This ensures that test-only code doesn&rsquo;t bloat your production binary.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300><strong>Testing Philosophy</strong>: When using fakes, our tests verify state and behavior outcomes rather than implementation details. This is fundamentally different from mock-based testing, which often focuses on verifying specific method calls were made in a specific order.</span></div><h3 id=5-writing-tests-with-fakes class="relative group">5. Writing Tests with Fakes <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-writing-tests-with-fakes aria-label=Anchor>#</a></span></h3><p>Now that we have our fakes, let&rsquo;s see how to write tests with them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>application_test</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/application&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/domain&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/ctxkeys&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/infrastructure/storage&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/infrastructure/logging_test&#34;</span> <span class=c1>// Import fake logger</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;testing&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/stretchr/testify/require&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestUserService_ActivateUser_Success</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Arrange: Setup fakes with desired state</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>ctxkeys</span><span class=p>.</span><span class=nx>CorrelationIDKey</span><span class=p>,</span> <span class=s>&#34;test-corr-id-123&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>initialEntity</span> <span class=o>:=</span> <span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=s>&#34;user1&#34;</span><span class=p>,</span> <span class=nx>IsActive</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Test User&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>fakeRepo</span> <span class=o>:=</span> <span class=nx>storage</span><span class=p>.</span><span class=nf>NewFakeRepository</span><span class=p>().</span><span class=nf>WithEntities</span><span class=p>(</span><span class=nx>initialEntity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fakeLogger</span> <span class=o>:=</span> <span class=nx>logging_test</span><span class=p>.</span><span class=nf>NewFakeLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>service</span> <span class=o>:=</span> <span class=nx>application</span><span class=p>.</span><span class=nf>NewUserService</span><span class=p>(</span><span class=nx>fakeRepo</span><span class=p>,</span> <span class=nx>fakeLogger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>userIDToActivate</span> <span class=o>:=</span> <span class=s>&#34;user1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Act: Execute the application logic</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>service</span><span class=p>.</span><span class=nf>ActivateUser</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userIDToActivate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Assert: Verify outcome via fake state</span>
</span></span><span class=line><span class=cl>    <span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Verify state change in Repository</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedEntity</span><span class=p>,</span> <span class=nx>getErr</span> <span class=o>:=</span> <span class=nx>fakeRepo</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userIDToActivate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>getErr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>True</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>updatedEntity</span><span class=p>.</span><span class=nx>IsActive</span><span class=p>,</span> <span class=s>&#34;Entity should be active&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>initialEntity</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>updatedEntity</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;Other fields should be unchanged&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Verify operations were recorded</span>
</span></span><span class=line><span class=cl>    <span class=nx>ops</span> <span class=o>:=</span> <span class=nx>fakeRepo</span><span class=p>.</span><span class=nf>GetOperations</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>require</span><span class=p>.</span><span class=nf>Len</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>ops</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=s>&#34;Expected Get and Save operations&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Verify logging occurred</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>GreaterOrEqual</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>fakeLogger</span><span class=p>.</span><span class=nf>Count</span><span class=p>(),</span> <span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Should have logged at least one message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>True</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>fakeLogger</span><span class=p>.</span><span class=nf>ContainsMessage</span><span class=p>(</span><span class=s>&#34;User activated&#34;</span><span class=p>),</span> <span class=s>&#34;Expected activation message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestUserService_ActivateUser_RepoError</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Arrange</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>repoErr</span> <span class=o>:=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;db connection lost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>fakeRepo</span> <span class=o>:=</span> <span class=nx>storage</span><span class=p>.</span><span class=nf>NewFakeRepository</span><span class=p>().</span>
</span></span><span class=line><span class=cl>        <span class=nf>WithEntities</span><span class=p>(</span><span class=nx>domain</span><span class=p>.</span><span class=nx>Entity</span><span class=p>{</span><span class=nx>ID</span><span class=p>:</span> <span class=s>&#34;user1&#34;</span><span class=p>,</span> <span class=nx>IsActive</span><span class=p>:</span> <span class=kc>false</span><span class=p>}).</span>
</span></span><span class=line><span class=cl>        <span class=nf>SimulateSaveError</span><span class=p>(</span><span class=nx>repoErr</span><span class=p>)</span> <span class=c1>// Configure fake to simulate error</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=nx>fakeLogger</span> <span class=o>:=</span> <span class=nx>logging_test</span><span class=p>.</span><span class=nf>NewFakeLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>service</span> <span class=o>:=</span> <span class=nx>application</span><span class=p>.</span><span class=nf>NewUserService</span><span class=p>(</span><span class=nx>fakeRepo</span><span class=p>,</span> <span class=nx>fakeLogger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Act</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>service</span><span class=p>.</span><span class=nf>ActivateUser</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;user1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Assert</span>
</span></span><span class=line><span class=cl>    <span class=nx>require</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>ErrorIs</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>repoErr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Verify error was logged</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>True</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>fakeLogger</span><span class=p>.</span><span class=nf>ContainsMessage</span><span class=p>(</span><span class=s>&#34;Failed to save&#34;</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>        <span class=s>&#34;Error should have been logged&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The key differences from traditional mock-based tests:</p><ol><li><strong>State-based verification</strong>: We check the outcome (entity is now active) rather than implementation details</li><li><strong>Fluent configuration</strong>: Fakes have builder-style methods for easy setup</li><li><strong>Resilience to refactoring</strong>: The test doesn&rsquo;t break if internal implementation changes</li><li><strong>Realistic behavior</strong>: Fakes implement the same interface as real components</li></ol><h2 id=testing-logging-with-fakes class="relative group">Testing Logging with Fakes <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#testing-logging-with-fakes aria-label=Anchor>#</a></span></h2><p>Testing logging is often overlooked, but it&rsquo;s a crucial part of application behavior, especially for diagnostics and audit trails. Our <code>FakeLogger</code> makes this straightforward:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestLoggingBehavior</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Arrange</span>
</span></span><span class=line><span class=cl>    <span class=nx>fakeLogger</span> <span class=o>:=</span> <span class=nx>logging_test</span><span class=p>.</span><span class=nf>NewFakeLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>service</span> <span class=o>:=</span> <span class=nf>NewServiceThatLogs</span><span class=p>(</span><span class=nx>fakeLogger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Act</span>
</span></span><span class=line><span class=cl>    <span class=nx>service</span><span class=p>.</span><span class=nf>DoSomethingImportant</span><span class=p>(</span><span class=s>&#34;test-value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Assert</span>
</span></span><span class=line><span class=cl>    <span class=nx>entries</span> <span class=o>:=</span> <span class=nx>fakeLogger</span><span class=p>.</span><span class=nf>GetEntries</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Find specific log messages</span>
</span></span><span class=line><span class=cl>    <span class=nx>found</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>entry</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>entries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>Level</span> <span class=o>==</span> <span class=s>&#34;info&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>Message</span> <span class=o>==</span> <span class=s>&#34;Operation started&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>found</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Check args contain our value</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nx>Args</span><span class=p>);</span> <span class=nx>i</span> <span class=o>+=</span> <span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>i</span><span class=o>+</span><span class=mi>1</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>                   <span class=nx>entry</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;input&#34;</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>                   <span class=nx>entry</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;test-value&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=c1>// Test passes</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Expected log message not found or missing expected arguments&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This verifies both that logging occurred and that the specific contextual data was included.</p><h2 id=factory-pattern-for-implementation-selection class="relative group">Factory Pattern for Implementation Selection <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#factory-pattern-for-implementation-selection aria-label=Anchor>#</a></span></h2><p>To manage which implementation (real or fake) is used, we can use a factory pattern:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>bootstrap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/application&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;myapp/internal/infrastructure/storage&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>IsDryRun</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Other config fields</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// NewRepository creates a repository based on configuration.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewRepository</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cfg</span> <span class=nx>Config</span><span class=p>,</span> <span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=nx>application</span><span class=p>.</span><span class=nx>Repository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>IsDryRun</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>storage</span><span class=p>.</span><span class=nf>NewFakeRepository</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>storage</span><span class=p>.</span><span class=nf>NewPostgresRepository</span><span class=p>(</span><span class=nx>db</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Similar factories for Logger, Notifier, etc.</span>
</span></span></code></pre></div><p>This enables features like dry-run mode while keeping the selection logic isolated.</p><h2 id=test-classification-strategy class="relative group">Test Classification Strategy <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#test-classification-strategy aria-label=Anchor>#</a></span></h2><p>With this architecture, we can employ a balanced testing strategy:</p><figure><img src=images/test-pyramid.svg alt="Test Pyramid showing the proportion of different test types" loading=lazy></figure><ol><li><p><strong>Unit Tests (~85-90%)</strong></p><ul><li>Domain Logic Tests: Test pure business logic directly</li><li>Service Tests (with Fakes): Test application service orchestration</li><li>Handler Tests (with Fake Services): Test HTTP/messaging handlers</li></ul></li><li><p><strong>Integration Tests (~5-10%)</strong></p><ul><li>Test real infrastructure components against real dependencies</li><li>Focused on critical interfaces between components</li></ul></li><li><p><strong>End-to-End Tests (~1-2%)</strong></p><ul><li>Test complete user journeys through the system</li><li>Fewer, focused on key scenarios</li></ul></li></ol><h2 id=directory-structure-for-tests class="relative group">Directory Structure for Tests <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#directory-structure-for-tests aria-label=Anchor>#</a></span></h2><p>Organizing tests logically helps maintainability:</p><pre tabindex=0><code>internal/
 application/
    service.go
    service_test.go       # Service Tests (using fakes)
    interfaces.go
 domain/
    model.go
    model_test.go         # Domain Unit Tests
 infrastructure/
     http/
        handler.go
        handler_test.go   # Handler Unit Tests
     logging/
        logger.go
        fake_logger_test.go # Fake Logger for tests
     storage/
         postgres_repository.go
         fake_repository.go # OR fake_repository_test.go
         postgres_repository_integration_test.go

test/
 integration/              # Broader integration tests
     setup/                # Test setup utilities
     api_test.go           # Full slice tests
</code></pre><p>Recommended placement:</p><ul><li><strong>Domain tests:</strong> In the domain package</li><li><strong>Service tests:</strong> In application_test package
-<strong>Handler tests:</strong> In infrastructure/http_test package</li><li><strong>Fake implementations:</strong> In *_test.go files or regular .go files if used for features</li><li><strong>Integration tests:</strong> In a separate test/ directory or with build tags</li></ul><h2 id=coming-up-in-part-3 class="relative group">Coming Up in Part 3 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#coming-up-in-part-3 aria-label=Anchor>#</a></span></h2><p>In the final part of this series, we&rsquo;ll explore:</p><ul><li>The value proposition of this architectural approach</li><li>Comparison with other testing methodologies</li><li>Advanced patterns like dry-run mode</li><li>Migration strategies for existing codebases</li><li>When this approach might not be appropriate</li></ul><p>Continue reading
<a href=/posts/architecting-for-testability-in-go/part-3/>Part 3: Real-World Applications and Advanced Patterns</a></p></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Nicholas Hammond</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Thoughts on software engineering, technology, and best practices</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/nichecode target=_blank aria-label=Github rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://nichecode.github.io/posts/architecting-for-testability-in-go/part-2/&amp;text=Architecting%20for%20Testability%20in%20Go%20%28Part%202%29:%20Implementation%20Strategy%20and%20Code%20Examples" title="Tweet on Twitter" aria-label="Tweet on Twitter" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://nichecode.github.io/posts/architecting-for-testability-in-go/part-2/&amp;title=Architecting%20for%20Testability%20in%20Go%20%28Part%202%29:%20Implementation%20Strategy%20and%20Code%20Examples" title="Share on LinkedIn" aria-label="Share on LinkedIn" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://nichecode.github.io/posts/architecting-for-testability-in-go/part-2/&amp;subject=Architecting%20for%20Testability%20in%20Go%20%28Part%202%29:%20Implementation%20Strategy%20and%20Code%20Examples" title="Send via email" aria-label="Send via email" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/architecting-for-testability-in-go/part-1/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Architecting for Testability in Go (Part 1): Foundations and Principles</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2025-04-10 01:00:00 +0000 UTC">10 April 2025</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/architecting-for-testability-in-go/part-3/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Architecting for Testability in Go (Part 3): Real-World Applications and Advanced Patterns</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2025-04-10 03:00:00 +0000 UTC">10 April 2025</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article></main><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12" id=to-top hidden=true><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="group mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a href=https://github.com/nichecode title target=_blank><span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">GitHub</span></a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Nicholas Hammond</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://nichecode.github.io/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>